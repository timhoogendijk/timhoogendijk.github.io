let synthEl=document.querySelector("[data-synthesize]"),playButtonEl=synthEl.querySelector('button[data-btn="play-pause"]'),stopButtonEl=synthEl.querySelector('button[data-btn="stop"]'),volumeSliderEl=synthEl.querySelector('[data-ui="volume-slider"]'),pitchSliderEl=synthEl.querySelector('[data-ui="pitch-slider"]'),rateSliderEl=synthEl.querySelector('[data-ui="rate-slider"]'),debugEl=synthEl.querySelector(".debug-msg"),voicesSelectEl=synthEl.querySelector("#voices-select"),textareaEl=synthEl.querySelector("#synth-text");pitchSliderEl.value=1,rateSliderEl.value=1,"speechSynthesis"in window||(debugEl.textContent="This browser does not support speechSynthesis",alert(debugEl.textContent),console.error(debugEl.textContent));let utterance=new SpeechSynthesisUtterance;utterance.text=textareaEl.value.trim(),utterance.lang="nl-NL",utterance.pitch=parseFloat(pitchSliderEl.value),utterance.rate=parseFloat(rateSliderEl.value),utterance.volume=parseFloat(volumeSliderEl.value);let isUsingLocalVoice=!1;function renderVoices(e){let t=[];e.forEach((e,n)=>{let{lang:l,name:o}=e;l=l.replace("_","-"),t.push(`<option value="${n}" data-lang="${l}" data-name="${o}">${o} (${l})</option>`)}),voicesSelectEl.innerHTML=t.join("")}function selectVoice(e,t){let n=voicesSelectEl.querySelector(`option${e}`),l=voicesSelectEl.querySelector(`option${t}`),o=null;(o=n||(l||voicesSelectEl.querySelector("option")))&&(o.setAttribute("selected",""),utterance.voice=voices[parseInt(o.value)],isUsingLocalVoice=utterance.voice.localService,console.log("isUsingLocalVoice",isUsingLocalVoice))}let voicesSet=!1,dutchLangCode="nl-NL",preferredDutchVoiceAttr='[data-name="Claire"][data-lang="nl-NL"]',otherDutchVoiceAttr='[data-lang="nl-NL"]',voices=speechSynthesis.getVoices();function changeVolume(e){console.log("change volume to",parseFloat(e.currentTarget.value)),utterance.volume=parseFloat(e.currentTarget.value)}function changePitch(e){console.log("change pitch to",parseFloat(e.currentTarget.value)),utterance.pitch=parseFloat(e.currentTarget.value)}function changeRate(e){console.log("change rate to",parseFloat(e.currentTarget.value)),utterance.rate=parseFloat(e.currentTarget.value)}console.log("voices",voices.length),"onvoiceschanged"in speechSynthesis&&0==voices.length?speechSynthesis.onvoiceschanged=(e=>{voicesSet?console.log("voicesChanged, but voice already set"):(voices=speechSynthesis.getVoices()).length>0&&(renderVoices(voices),selectVoice(preferredDutchVoiceAttr,otherDutchVoiceAttr),voicesSet=!0)}):voices.length>0&&(renderVoices(voices),selectVoice(preferredDutchVoiceAttr,otherDutchVoiceAttr),voicesSet=!0),voicesSelectEl.addEventListener("change",e=>{console.log(e.currentTarget.value),utterance.voice=voices[parseInt(e.currentTarget.value)],isUsingLocalVoice=utterance.voice.localService,console.log("isUsingLocalVoice",isUsingLocalVoice)}),playButtonEl.addEventListener("click",e=>{if(speechSynthesis.pending)return debugEl.textContent="synth: is pending, please wait",void console.log(debugEl.textContent);if(!speechSynthesis.speaking){if(utterance.text!=textareaEl.value.trim()&&(utterance.text=textareaEl.value.trim()),0==utterance.text.length)return debugEl.textContent="warning: no text found",textareaEl.focus(),void console.log(debugEl.textContent);debugEl.textContent="synth: start speaking",console.log(debugEl.textContent),speechSynthesis.speak(utterance)}}),stopButtonEl.addEventListener("click",e=>{keepPlayingInterval&&(clearInterval(keepPlayingInterval),keepPlayingInterval=null),speechSynthesis.cancel()}),volumeSliderEl.addEventListener("change",e=>changeVolume(e)),pitchSliderEl.addEventListener("change",e=>changePitch(e)),rateSliderEl.addEventListener("change",e=>changeRate(e));let keepPlayingInterval=null;function keepPlaying(){speechSynthesis.speaking&&!isUsingLocalVoice&&speechSynthesis.resume()}utterance.addEventListener("start",function(e){debugEl.textContent="utterance: start",console.log(debugEl.textContent),keepPlayingInterval||(keepPlayingInterval=setInterval(function(){keepPlaying()},100))}),utterance.addEventListener("pause",e=>{debugEl.textContent="utterance: pause",console.log(debugEl.textContent,speechSynthesis)}),utterance.addEventListener("resume",function(e){debugEl.textContent="utterance: resume",console.log(debugEl.textContent)}),utterance.addEventListener("end",function(e){debugEl.textContent=`utterance: end (took ${e.elapsedTime}ms})`,keepPlayingInterval&&(clearInterval(keepPlayingInterval),keepPlayingInterval=null)}),utterance.onerror=function(e){console.log(e.code)},utterance.addEventListener("error",e=>{debugEl.textContent=`synth: error (${e.error})`,console.log(debugEl.textContent,e),console.log("voice?",utterance.voice),keepPlayingInterval&&(clearInterval(keepPlayingInterval),keepPlayingInterval=null),speechSynthesis.cancel()}),utterance.addEventListener("boundary",function(e){debugEl.textContent=`utterance: boundary (charIndex ${e.charIndex} @${e.elapsedTime}ms)`}),window.addEventListener("beforeunload",e=>{console.log("onbeforeunload"),speechSynthesis.speaking&&speechSynthesis.pause(),speechSynthesis.cancel()});
